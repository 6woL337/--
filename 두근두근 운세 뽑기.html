<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="icon/favicon.png">
<title>ë‘ê·¼ë‘ê·¼ ìš´ì„¸ ë³´ê¸°</title>

<style>

* {
  user-select: none !important;
}

::selection {
  background: transparent;
}

input,
textarea {
  user-select: text !important;
}

html, body, * { cursor: url("icon/cursor.png") 2 2, auto !important; }

button,
#box,
#stick {
  cursor: url("icon/cursor.png") 2 2, auto;
}

html, body, *:active { cursor: url("icon/cursor2.png") 2 2, auto !important; }

/* ---------- ê¸°ì¡´ ì˜¤ë¯¸ì¿ ì§€ ìŠ¤íƒ€ì¼ (ì›ë³¸ ìœ ì§€)s ---------- */
:root {
  --box-width: 250px;
  --box-height: 400px;
  --stick-width: 40px;
  --stick-height: 160px;
}

#startScreen {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100vh;
  background: #fbeedc;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 999;
  background: url("body_img/bg/start_bg.webp") no-repeat center/cover;
}

#titleImg{
  width: 600px;          /* íƒ€ì´í‹€ ì´ë¯¸ì§€ í¬ê¸° */
  max-width: 80vw;       /* ëª¨ë°”ì¼ ëŒ€ì‘ */
  margin-top: -100px;
  margin-bottom: 30px;  /* ë²„íŠ¼ê³¼ ê°„ê²© */
  pointer-events: none; /* í´ë¦­ ë°©í•´ ë°©ì§€ */
}

#startBtn { 
padding: 14px 26px; 
background: #ef5350; 
font-size: 20px; 
border-radius: 8px; 
color: white; 
border: none; 
cursor: pointer; 
box-shadow: 0 3px 6px rgba(0,0,0,0.25);
margin-top: -50px;
} 

#startBtn:active { 
transform: scale(0.95); 
}

/* ğŸ”¥ ì¶”ê°€ëœ ë¡œë”© í™”ë©´ */
#loadingScreen {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100vh;
  background: rgba(0,0,0,0.6);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 998;
}

#loadingImg { 
width: 300px; 
height: auto; 
margin-bottom: 20px; 
animation: shakeImg 0.5s infinite ease-in-out; 
}

@keyframes shakeImg { 
0%{transform:translate(0,0) rotate(0deg);}
25%{transform:translate(-3px,0) rotate(-3deg);}
50%{transform:translate(0,-2px) rotate(3deg);}
75%{transform:translate(3px,0) rotate(0deg);}
100%{transform:translate(0,0) rotate(-3deg);} 
}

#loadingBarWrap{ 
width:300px; 
height:22px; 
background:#ddd; 
border-radius:10px; 
overflow:hidden; 
margin-top:20px; 
}

#loadingBar{ 
width:0%; 
height:100%; 
background: linear-gradient(90deg,#ff9800,#ffca28); 
transition: width 0.2s; 
}

/* í”Œë ˆì´ í™”ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
#gameScreen { 
display: none; 
flex-direction: column; 
justify-content: center; 
align-items: center; 
position: relative; 
background: url("body_img/bg/game_bg.webp") no-repeat center/cover; 
width: 100%; 
height: 100%; 
}

/* ìºë¦­í„° ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
.character-left { 
position: absolute; 
left: 100px; 
top: 110%; 
transition: top 1.2s ease-out; 
width: 550px; 
height: 770px; 
opacity: 0; 
z-index: 25; 
}

.character-right { 
position: absolute; 
right: 100px; 
top: 110%; 
transition: top 1.2s ease-out; 
width: 550px; 
height: 770px; 
opacity: 0; 
z-index: 25; 
}

@keyframes shakeLeft { 
0%{transform:translateY(-50%) rotate(0deg);}
25%{transform:translateY(-50%) rotate(-2deg);}
50%{transform:translateY(-50%) rotate(2deg);}
75%{transform:translateY(-50%) rotate(-1deg);}
100%{transform:translateY(-50%) rotate(0deg);} 
}

@keyframes shakeRight { 
0%{transform:translateY(50%) rotate(0deg);}
25%{transform:translateY(50%) rotate(2deg);}
50%{transform:translateY(50%) rotate(-2deg);}
75%{transform:translateY(50%) rotate(1deg);}
100%{transform:translateY(50%) rotate(0deg);} 
}

@keyframes fastShakeLeft { 
0%{transform:translateY(-50%) rotate(0deg);}
20%{transform:translateY(-50%) rotate(-6deg);}
40%{transform:translateY(-50%) rotate(6deg);}
60%{transform:translateY(-50%) rotate(-4deg);}
80%{transform:translateY(-50%) rotate(4deg);}
100%{transform:translateY(-50%) rotate(0deg);} 
}

@keyframes fastShakeRight { 
0%{transform:translateY(-50%) rotate(0deg);}
20%{transform:translateY(-50%) rotate(6deg);}
40%{transform:translateY(-50%) rotate(-6deg);}
60%{transform:translateY(-50%) rotate(4deg);}
80%{transform:translateY(-50%) rotate(-4deg);}
100%{transform:translateY(-50%) rotate(0deg);} 
}

.character-left.show { 
top:50%; 
transform: translateY(50%); 
opacity:1; 
animation: shakeLeft 1.8s infinite ease-in-out; 
}

.character-right.show{ 
top:50%; 
transform: translateY(50%); 
opacity:1; 
animation: shakeLeft 1.8s infinite ease-in-out; 
}

.fast-shake{ 
animation: fastShakeLeft 0.35s infinite ease-in-out !important; 
}

body { 
margin: 0; 
height: 100vh; 
display: flex; 
flex-direction: column; 
justify-content: center; 
align-items: center; 
font-family: sans-serif; 
background: #f9f3e7; 
overflow: hidden; 
}

#container { 
position: relative; 
width: var(--box-width); 
height: calc(var(--box-height) + var(--stick-height)); display: flex; 
justify-content: center; 
align-items: flex-end; 
}

#box { 
width: var(--box-width); 
height: var(--box-height); 
background: url("body_img/bg/box.webp") no-repeat center/contain; 
background-size:100% 100%; 
border-radius:8px; 
position: relative; 
z-index:25; 
}

#stick { 
width: var(--stick-width); 
height: var(--stick-height); 
background:#fff; 
border-radius:6px; 
position:absolute; 
left:50%; 
transform:translateX(-50%); 
bottom:0; 
z-index:20; 
display:flex; 
justify-content:center; 
align-items:flex-start;  
transition: bottom 1s ease-out; 
box-shadow:0 2px 5px rgba(0,0,0,0.2); 
}

#stickText { 
font-size:18px; 
margin-top:6px; 
opacity:0; 
transition: opacity 0.3s ease; 
}

@keyframes shakeBox { 
0%{transform:rotate(0deg);}
20%{transform:rotate(10deg);}
40%{transform:rotate(-10deg);}
60%{transform:rotate(6deg);}
80%{transform:rotate(-6deg);}
100%{transform:rotate(0deg);} 
}

.shaking { 
animation: shakeBox 0.8s ease; 
}

#paperWrapper {
  position:fixed;
  top: 0px; /* ì¢…ì´ê°€ ë” ìœ„ì—ì„œ ì‹œì‘ */
  left:50%;
  width:400px;
  height:800px;
  padding: 0;
  opacity:0;
  background:url("body_img/result/paper_ëŒ€ê¸¸.webp") no-repeat center/cover;
  background-size:100% 100%;
  border-radius:6px;
  z-index:900;

  /* ğŸ”¥ ìŠ¬ë¼ì´ë“œ ë‚´ë ¤ì˜¤ê¸° ì• ë‹ˆë©”ì´ì…˜ */
  transform: translate(-50%, -250px);
  transition: transform 1s ease-out, opacity .6s ease;
}
#paperWrapper.show {
  opacity:1;
  transform: translate(-50%, 20px); /* box ì•ìª½ìœ¼ë¡œ ë–¨ì–´ì§ */
}

#paperText {
  padding: 40px 20px;
  font-size: 0px;
  opacity:0;
  transition: opacity .8s ease .4s;
}
#paperText.show {
  opacity:1;
}

button{ 
padding:12px 24px; 
font-size:16px; 
background:#f9a825; 
border:none; 
border-radius:6px; 
color:#fff; 
font-weight:bold; 
cursor:pointer; 
box-shadow:0 3px 6px rgba(0,0,0,0.2); 
}

button:active{ 
transform: scale(0.96); 
}

#draw{ 
margin-top:40px; 
z-index: 800; 
}

#resetBtn{ 
position:absolute; 
top: calc(100% + 140px); 
left:50%; 
transform:translateX(-50%); 
display:none; 
z-index:30; 
width:300px; 
padding:14px 0; 
font-size:18px; 
z-index: 800; 
}

#backToStartBtn{ 
position:absolute; 
top:10px; 
left:10px; 
width:200px; 
padding:10px 18px; 
font-size:14px; 
background:#d9534f; 
color:white; 
border:none; 
border-radius:6px; 
cursor:pointer; 
z-index:999; 
box-shadow:0 3px 6px rgba(0,0,0,0.25); 
}

#backToStartBtn:active{ 
transform: scale(0.95); 
}

#muteBtn{ 
position:absolute; 
top:10px; 
left:220px; 
width:60px; 
padding:10px 18px; 
font-size:14px; 
background:#333; 
color:white; 
border:none; 
border-radius:6px; 
cursor:pointer; 
z-index:999; 
}

#muteBtn:active{ 
transform: scale(0.95); 
}

/* íŒŒí‹°í´ */
#particleArea{ 
position: fixed; 
top:0; 
left:0; 
width:100%; 
height:100%; 
pointer-events:none; 
overflow:hidden; 
z-index:999; 
}

.firework-particle{ 
position:absolute; 
width:8px; 
height:8px; 
background:white; 
border-radius:50%; 
opacity:1; 
pointer-events:none; 
animation: explode 1.2s ease-out forwards; 
}

@keyframes explode { 
0%{transform:translate(0,0) scale(1); opacity:1;}
100%{transform:translate(var(--dx), var(--dy)) scale(0.2); opacity:0;} }

#paperParticleArea {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
  top: 0;
  left: 0;
  overflow: visible;
  z-index: 999;
}

.paper-particle {
  position: absolute;
  background: url("particle/particle_ëŒ€ê¸¸.webp") no-repeat center / cover;
  border-radius: 0;
  opacity: 0;
  animation: paperParticleAnim 1.9s ease-out forwards;
}

@keyframes paperParticleAnim {
  0% {
    transform: scale(0.4) translate(0, 0);
    opacity: 1;
  }
  60% {
    opacity: 1;
  }
  100% {
    transform: scale(1.1) translate(var(--tx), var(--ty));
    opacity: 0;
  }
}

/* ---------- ë°©ëª…ë¡ ìŠ¤íƒ€ì¼ (ì›ë³¸ ìœ ì§€) ---------- */
:root{ 
--bg:#f7f3e9; 
--ink:#5c4a32; 
--panel:#fffdfa; 
--accent:#c8ba9e; 
--btn:#d9cbaa; 
}

html,body{ 
background:var(--bg); 
color:var(--ink); 
}

/* íë¥´ëŠ” í…ìŠ¤íŠ¸ */
@keyframes flow-right-to-left{ 0%{ transform: translateX(100vw);}100%{ transform: translateX(-120vw);} }

.flow-text {
  position: absolute;
  white-space: nowrap;
  font-weight: 500;
  pointer-events: auto;
  cursor: grab;
  opacity: 0.9;
  animation-name: flow-right-to-left;
  animation-timing-function: linear;
  z-index: 15;
  display: inline-block;
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
  will-change: transform, left, top;
  transform-origin: top left;

  cursor: url("icon/flow_cursor.png") 4 4, grab !important;

  background: #fffdfa;        /* ë°°ê²½ */
  border: 2px solid #5c4a32;  /* í…Œë‘ë¦¬ */
  border-radius: 10px;        /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
  padding: 6px 10px;          /* ì•ˆìª½ ì—¬ë°± */
}

.flow-text.grabbing {
  cursor: url("icon/flow_cursor_click.png") 4 4, grabbing !important;
  animation-play-state: paused; /* ì¡ìœ¼ë©´ íë¦„ ë©ˆì¶¤ */
}

/* íŒ¨ë„ */
#panel{ 
position:fixed; 
top:0; 
right:-400px; 
width:400px; 
height:100vh; 
background:var(--panel); 
border-left:3px solid var(--accent); 
box-shadow:-6px 0 18px rgba(0,0,0,0.08); 
padding:20px; 
box-sizing:border-box; 
transition: right .35s ease; 
overflow-y:auto; 
z-index:1100; 
}

#panel h3{ 
margin:0 0 14px; 
font-size:18px; 
color:#6d552f; 
}

.note-item{ 
background:#fff9d9; 
padding:10px; 
margin-bottom:12px; 
border:1px solid #d8c797; 
border-radius:6px; 
position:relative; 
}

.note-item .nick{ 
font-weight:700; 
margin-bottom:6px; 
}

.delete-btn{ 
position:absolute; 
padding: 4px 8px;
right:8px; 
top:8px; 
background:none; 
border:none; 
color:#8a6e42; 
cursor:pointer; 
font-size:13px; 
}

/* ë°©ëª…ë¡ ë²„íŠ¼ (game í™”ë©´ì— ë°°ì¹˜) */
#toggle{ 
position:absolute; 
right: 32px; 
top: 10px; 
background:#fff3b0; 
border:2px 
solid #c5b27b; 
padding:10px 14px; 
border-radius:8px; 
cursor:pointer; 
font-size:14px;  
z-index:1101; 
}

/* ì…ë ¥ ì˜ì—­ */
.input-area{ 
position:fixed; 
left:20px; 
bottom:20px; 
right:50px; 
display:flex; 
gap:10px; 
flex-direction:column; 
z-index:500; 
}

textarea#msg{ 
width:100%; 
height:70px; 
padding:10px; 
border-radius:8px; 
border:2px 
dashed #c4b69b; 
background:#fffef8; 
resize:none; 
font-size:15px; 
}

.row{ 
display:flex; 
gap:10px; 
}

.small-input{ 
width:160px; 
padding:8px; 
border-radius:6px; 
border:1px 
solid #c8bba7; 
background:#fffefc; 
}

button.primary{ 
padding:10px 16px; 
border-radius:8px; 
border:2px 
solid #9c8c6a; 
background:var(--btn); 
cursor:pointer; 
font-weight:700; 
}

/* íë¥´ëŠ” í…ìŠ¤íŠ¸ì„ ìºë¦­í„° ë’¤ë¡œ ìœ„ì¹˜ì‹œí‚¤ê¸° ìœ„í•´ flowAreaì˜ z-indexë¥¼ characterë³´ë‹¤ ë‚®ê²Œ ìœ ì§€ */
#flowArea{ 
position:fixed; 
top:0; 
left:0; 
width:100%; 
height:100%; 
pointer-events:auto;
z-index:18; 
overflow:hidden; 
}

/* ë°˜ì‘í˜• ê°„ë‹¨ ë³´ì • */
@media (max-width:800px){ 
.character-left,.character-right{ display:none; } 

#container{ transform:scale(0.9);} 
#panel{ width:320px; right:-320px; } 
.input-area{ right:340px; } }

.character-left.pressed,
.character-right.pressed {
  animation: none !important;
  transform: translateY(-50%) scale(0.85) !important;
  transition: transform 0.12s ease;
}

/* ê¸°ë³¸ ìŠ¬ë¼ì´ë” ì™¸í˜• ì´ˆê¸°í™” + ê³µí†µ ì„¤ì • */
input[type="range"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  width: 150px;      /* ë„ˆ htmlì—ì„œ ì¤€ width */
  height: 8px;       /* íŠ¸ë™ ë†’ì´ */
  background: transparent;
  cursor: pointer;
  margin: 0;         /* í•„ìš”í•˜ë©´ ì¡°ì ˆ */
}

/* íŠ¸ë™ (ë°°ê²½ ë§‰ëŒ€) ìŠ¤íƒ€ì¼ â€” WebKit ê³„ì—´ */
input[type="range"]::-webkit-slider-runnable-track {
  height: 8px;
  background: #ccc;     /* íŠ¸ë™ ìƒ‰ìƒ */
  border-radius: 4px;
}

/* thumb (ìŠ¬ë¼ì´ë” ì†ì¡ì´) ìŠ¤íƒ€ì¼ â€” WebKit ê³„ì—´ */
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: #ff9800;  /* ì†ì¡ì´ ìƒ‰ìƒ */
  border-radius: 50%;   /* ì› ëª¨ì–‘ */
  border: 2px solid #e67e22;  /* í…Œë‘ë¦¬ */
  margin-top: -5px;     /* íŠ¸ë™ ì¤‘ì•™ ì •ë ¬ (íŠ¸ë™ ë†’ì´ì— ë”°ë¼ ì¡°ì ˆ) */
}

/* Firefox ì „ìš© ìŠ¤íƒ€ì¼ (::-moz-*)  */
input[type="range"]::-moz-range-track {
  height: 8px;
  background: #ccc;
  border-radius: 4px;
}
input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #ff9800;
  border-radius: 50%;
  border: 2px solid #e67e22;
}

/* ê¸°ë³¸ ìŠ¬ë¼ì´ë” ì™¸í˜• ì´ˆê¸°í™” + ê³µí†µ ì„¤ì • */
input[type="range"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  width: 150px;      /* ë„ˆ htmlì—ì„œ ì¤€ width */
  height: 8px;       /* íŠ¸ë™ ë†’ì´ */
  background: transparent;
  cursor: pointer;
  margin: 0;         /* í•„ìš”í•˜ë©´ ì¡°ì ˆ */
}

/* íŠ¸ë™ (ë°°ê²½ ë§‰ëŒ€) ìŠ¤íƒ€ì¼ â€” WebKit ê³„ì—´ */
input[type="range"]::-webkit-slider-runnable-track {
  height: 8px;
  background: #CCB189;     /* íŠ¸ë™ ìƒ‰ìƒ */
  border-radius: 4px;
}

/* thumb (ìŠ¬ë¼ì´ë” ì†ì¡ì´) ìŠ¤íƒ€ì¼ â€” WebKit ê³„ì—´ */
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: #904943;  /* ì†ì¡ì´ ìƒ‰ìƒ */
  border-radius: 50%;   /* ì› ëª¨ì–‘ */
  border: 2px solid #4C3421;  /* í…Œë‘ë¦¬ */
  margin-top: -5px;     /* íŠ¸ë™ ì¤‘ì•™ ì •ë ¬ (íŠ¸ë™ ë†’ì´ì— ë”°ë¼ ì¡°ì ˆ) */
}

/* Firefox ì „ìš© ìŠ¤íƒ€ì¼ (::-moz-*)  */
input[type="range"]::-moz-range-track {
  height: 8px;
  background: #ccc;
  border-radius: 4px;
}
input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #ff9800;
  border-radius: 50%;
  border: 2px solid #e67e22;
}

.sliderBox {
  position: absolute;
  top: 10px;
  left: 290px;
  width: 180px;

  background: #F0E5D0;  /* ğŸ ë°•ìŠ¤ ë°°ê²½ */
  border-radius: 10px;

  display: flex;
  justify-content: center;
  align-items: center;

  padding: 15px 10px;
  border: 2px solid #C2B09C;
}

/* í™•ë¥  ì •ë³´ ë²„íŠ¼ */
#probBtn{
  position:absolute;
  top:60px;
  right:32px; /* ë°©ëª…ë¡ ë²„íŠ¼ ì˜† */
  padding:10px 14px;
  font-size:14px;
  border-radius:8px;
  border:2px solid #c5b27b;
  background:#fff3b0;
  cursor:pointer;
  z-index:1000;
}

/* í™•ë¥  íŒ¨ë„ */
#probPanel{
  position:absolute;
  top:60px;
  right:32px;
  width:260px;
  background:#fffdfa;
  border:2px solid #c8ba9e;
  border-radius:10px;
  padding:14px;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);

  /* ì ‘íŒ ìƒíƒœ */
  max-height:0;
  overflow:hidden;
  opacity:0;
  transform: translateY(-10px);
  transition: all 0.35s ease;
  z-index:999;
}

/* í¼ì³ì§„ ìƒíƒœ */
#probPanel.open{
  max-height:300px;
  opacity:1;
  transform: translateY(0);
}

#probPanel h3{
  margin:0 0 8px;
  font-size:16px;
}

#probPanel ul{
  padding-left:18px;
  margin:0;
}

.smoke{
  position: fixed;
  top: 50%;
  width: 500px;
  height: 500px;
  pointer-events: none;
  opacity: 0;
  z-index: 60;
  background: url("effect/smoke.webp") center/contain no-repeat;
  filter: blur(2px);
  transform: translateY(-50%) scale(0.8);
}

#smokeLeft{
  left: 40px;
}

#smokeRight{
  right: 40px;
}

.smoke.show{
  animation: smokeFade 0.6s ease-out forwards;
}

@keyframes smokeFade{
  0%{
    opacity: 0;
    transform: translateY(-50%) scale(0.7);
  }
  40%{
    opacity: 0.9;
    transform: translateY(-50%) scale(1);
  }
  100%{
    opacity: 0;
    transform: translateY(-50%) scale(1.2);
  }
}

#dragLayer {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999; 
}

/* ğŸ”¥ íŠ¹ì • ë‹‰ë„¤ì„ìš© ìŠ¤íƒ€ì¼ */
.flow-text.special {
  background: #86abd9;        /* ë°•ìŠ¤ ë°°ê²½ìƒ‰ ë³€ê²½ */
  border-color: #131cc7;      /* í…Œë‘ë¦¬ ìƒ‰ */
  color: #131cc7;             /* ê¸€ì ìƒ‰ */
}

.note-item.special-note {
  background: #86abd9;
  border-color: #131cc7;
}

.note-item.special-note .text {
  font-weight: 600;
  color: #131cc7;
}

</style>
</head>
<body>

<!-- íë¥´ëŠ” í…ìŠ¤íŠ¸ ì „ìš© ì˜ì—­ (ìºë¦­í„° ë’¤ìª½) -->
<div id="flowArea"></div>

<!-- ìºë¦­í„° ì´ë¯¸ì§€ë“¤ (ì›ë³¸) -->
<img id="charLeft" class="character-left" src="character_img/left.webp" alt="left">
<img id="charRight" class="character-right" src="character_img/right.webp" alt="right">

<!-- ì¢Œì¸¡ ì—°ê¸° -->
<div id="smokeLeft" class="smoke"></div>

<!-- ìš°ì¸¡ ì—°ê¸° -->
<div id="smokeRight" class="smoke"></div>

<!-- ì‹œì‘ í™”ë©´ -->
<div id="startScreen">
<img src="body_img/bg/íƒ€ì´í‹€.webp" alt="ì˜¤ë¯¸ì¿ ì§€" id="titleImg">
<button id="startBtn" class="start-btn">ì‹œì‘í•˜ê¸°</button>
</div>

<!-- ë¡œë”© í™”ë©´ -->
<div id="loadingScreen">
  <img id="loadingImg" src="character_img/loading/load_1.webp" alt="loading">
  <div id="loadingText" style="color:white; font-size:20px; margin-top:10px;"></div>
  <div id="loadingBarWrap"><div id="loadingBar"></div></div>
</div>

<!-- í”Œë ˆì´ í™”ë©´ -->
<div id="gameScreen">

  <button id="backToStartBtn">ì‹œì‘ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  <button id="muteBtn">ğŸ”Š</button>
<div class="sliderBox">
  <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="1">
</div>
        <button id="toggle">ğŸ“’ ë°©ëª…ë¡</button>

<button id="probBtn">í™•ë¥  ì •ë³´</button>

<div id="probPanel">
  <h3>ğŸ¯ ì ê´˜ í™•ë¥  ì•ˆë‚´</h3>
  <ul>
    <li>ëŒ€ê¸¸ : 10%</li>
    <li>ì¤‘ê¸¸ : 15%</li>
    <li>ì†Œê¸¸ : 25%</li>
    <li>ì†Œí‰ : 25%</li>
    <li>ì¤‘í‰ : 15%</li>
    <li>ëŒ€í‰ : 10%</li>
  </ul>
</div>

  <div id="container">
    <div id="stick"><span id="stickText"></span></div>
    <div id="box"></div>

    <div id="paperWrapper"><div id="paperText"></div></div>

<div id="paperParticleArea"></div>

    <button id="resetBtn">ì ê´˜ ë‹¤ì‹œë³´ê¸°</button>
  </div>

  <button id="draw">ì ê´˜ ë³´ê¸°</button>

  <!-- íŒŒí‹°í´ ì˜ì—­ -->
  <div id="particleArea"></div>

  <!-- BGM -->
<!-- BGM: ì‹œì‘ ë²„íŠ¼ ëˆŒëŸ¬ì•¼ í•„ìš” -->
<audio id="bgm" src="bgm/bg/main_bgm.mp3" loop preload="none"></audio>

<!-- íš¨ê³¼ìŒ: ë¹ ë¥´ê²Œ í•„ìš” -->
<audio id="clickSound" src="bgm/bg/click.mp3" preload="auto"></audio>
<audio id="startSound" src="bgm/bg/start.mp3" preload="auto"></audio>
<audio id="shakeSound" src="bgm/bg/shake.mp3" preload="auto"></audio>
<audio id="c_clickSound" src="bgm/bg/c_click.mp3" preload="auto"></audio>

<!-- ê²°ê³¼ BGM -->
<audio id="bgm_ëŒ€ê¸¸" src="bgm/result/ëŒ€ê¸¸.mp3" preload="auto"></audio>
<audio id="bgm_ì¤‘ê¸¸" src="bgm/result/ì¤‘ê¸¸.mp3" preload="auto"></audio>
<audio id="bgm_ì†Œê¸¸" src="bgm/result/ì†Œê¸¸.mp3" preload="auto"></audio>
<audio id="bgm_ì†Œí‰" src="bgm/result/ì†Œí‰.mp3" preload="auto"></audio>
<audio id="bgm_ì¤‘í‰" src="bgm/result/ì¤‘í‰.mp3" preload="auto"></audio>
<audio id="bgm_ëŒ€í‰" src="bgm/result/ëŒ€í‰.mp3" preload="auto"></audio>

<!-- í­ë°œìŒ -->
<audio id="boomL" src="bgm/result/boom-L.mp3" preload="auto"></audio>
<audio id="boomR" src="bgm/result/boom-R.mp3" preload="auto"></audio>
</div>

<!-- ë°©ëª…ë¡ íŒ¨ë„ (ì˜¤ë¥¸ìª½ì—ì„œ ìŠ¬ë¼ì´ë“œ) -->
<div id="panel">

    <h3>ğŸ“‘ ë°©ëª…ë¡</h3>
    <h4>*í•´ë‹¹ ê¸°ë¡ë“¤ì€ ì¼ì • ê¸°ê°„ ì´ìƒ ë³´ê´€ í›„ ì†Œì‹¤ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.*</h4>

  <div id="list"></div>
</div>

<!-- ì…ë ¥ ì˜ì—­ (ì›ë³¸ ìœ ì§€) -->
<div class="input-area">
  <div class="row">
    <input id="nickPreview" class="small-input" disabled />
    <button id="changeNickInline" class="primary" style="width:120px;">ë‹‰ë„¤ì„ ìˆ˜ì •</button>
    <button id="send" class="primary" style="background:#b9d3a8;border-color:#93b183;">ë“±ë¡</button>
  </div>
  <textarea id="msg" placeholder="ë©”ëª¨ì²˜ëŸ¼ í•œ ì¤„ ë‚¨ê²¨ë³´ì„¸ìš” :)"></textarea>
</div>

<!-- ë°©ëª…ë¡ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ (Firebase í¬í•¨) -->
<script type="module">

let firebaseInited = false;

async function initFirebase() {
  if (firebaseInited) return;
  firebaseInited = true;

  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js");
  const {
    getFirestore, collection, addDoc, onSnapshot,
    deleteDoc, doc, serverTimestamp, orderBy, query
  } = await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js");

  const firebaseConfig = {
    apiKey: "AIzaSyDF4cfl2658vOEvGmVrAd2PZhb_GbRC83w",
    authDomain: "guestbook-b1d14.firebaseapp.com",
    projectId: "guestbook-b1d14",
    storageBucket: "guestbook-b1d14.firebasestorage.app",
    messagingSenderId: "655941756386",
    appId: "1:655941756386:web:cb198da93a58f53e8e05bb",
    measurementId: "G-4ZBLTP3SFD"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const toggle = document.getElementById('toggle');
  const panel = document.getElementById('panel');
  const list = document.getElementById('list');
  const sendBtn = document.getElementById('send');
  const msgInput = document.getElementById('msg');
  const changeNickInline = document.getElementById('changeNickInline');
  const nickPreview = document.getElementById('nickPreview');

  const colRef = collection(db, "messages");
  const messagesQuery = query(colRef, orderBy("time","desc"));

  /* ë‹‰ë„¤ì„ */
  let myNick = localStorage.getItem('nickname');
  function askNicknameIfNeeded(){
    if(!myNick){
      const input = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
      myNick = input && input.trim() ? input.trim() : "ìµëª…";
      localStorage.setItem('nickname', myNick);
    }
    applyNick();
  }
  function applyNick(){ nickPreview.value = myNick; }
  function changeNicknameFlow(){
    const newNick = prompt("ìƒˆ ë‹‰ë„¤ì„:", myNick);
    if(!newNick) return;
    myNick = newNick.trim();
    localStorage.setItem('nickname', myNick);
    applyNick();
  }
  askNicknameIfNeeded();
changeNickInline.addEventListener("click", () => {
    clickSound.currentTime = 0;
    clickSound.play();

    changeNicknameFlow(); 
});

const probBtn = document.getElementById("probBtn");
const probPanel = document.getElementById("probPanel");

let probOpen = false;

probBtn.addEventListener("click", () => {
  clickSound.currentTime = 0;
  clickSound.play();

  probOpen = !probOpen;
  probPanel.classList.toggle("open", probOpen);
  probBtn.textContent = probOpen ? "í™•ë¥  ë‹«ê¸°" : "í™•ë¥  ì •ë³´";
});


  /* íŒ¨ë„ í† ê¸€ */
  let open = false;
  toggle.addEventListener("click", ()=>{ 
  clickSound.currentTime = 0;
  clickSound.play();
  open = !open; 
  panel.style.right = open ? "0px" : "-400px"; 
  toggle.textContent = open ? "ë°©ëª…ë¡ ë‹«ê¸°" : "ğŸ“’ ë°©ëª…ë¡";
});

const SPECIAL_NICK_MAP = {
  [normalizeNick("ì›ì¤€ì‹ì „ë„ì‹œë½í­íƒ„ë‘ë¦¬ì¹˜í‚¨ë”ì¡°ì´")]: {
    label: "ê´€ë¦¬ì_ì›",
    color: "#131cc7"
  },
  [normalizeNick("ë©”ì´ë“œìŸê°•ì¤€í˜¸")]: {
    label: "ê´€ë¦¬ì_ê°•",
    color: "#131cc7"
  }
};

const EASTER_EGG_NICK_MAP = {
  [normalizeNick("ê°•ì¤€í˜¸")]: "ê²Œì´",
  [normalizeNick("ê²Œì´")]: "ê°•ì¤€í˜¸",
  [normalizeNick("ì›ì¤€")]: "ë‚˜ì›ì¤€ì•„ë‹ˆë‹¤"
};

function getDisplayNick(rawNick) {
  const n = normalizeNick(rawNick);

  if (SPECIAL_NICK_MAP[n]) {
    return SPECIAL_NICK_MAP[n].label;
  }

  if (EASTER_EGG_NICK_MAP[n]) {
    return EASTER_EGG_NICK_MAP[n];
  }

  return rawNick;
}

  const messagesMap = new Map();
  const spawnerActive = new Map();

// ğŸ”¥ ë‹‰ë„¤ì„ ì •ê·œí™” (ì „ì—­)
function normalizeNick(nick) {
  return (nick || "")
    .normalize("NFC")
    .replace(/[\s\u200b-\u200d\ufeff]/g, "");
}

// ğŸ”¥ íŠ¹ì • ë‹‰ë„¤ì„ ëª©ë¡ (ì „ì—­)
const SPECIAL_NICK = [
  "ì›ì¤€ì‹ì „ë„ì‹œë½í­íƒ„ë‘ë¦¬ì¹˜í‚¨ë”ì¡°ì´",
  "ë©”ì´ë“œìŸê°•ì¤€í˜¸"
].map(normalizeNick);

  /* ë©”ì‹œì§€ ë“±ë¡ */
  sendBtn.addEventListener('click', async ()=>{
    clickSound.currentTime = 0;
    clickSound.play();
    const text = msgInput.value.trim();
    if(!text){ alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
    await addDoc(colRef, { nick: myNick, text: text, time: serverTimestamp() });
    msgInput.value="";
  });

  async function deleteMessage(id){ await deleteDoc(doc(db,"messages",id)); }

  function escapeHtml(s){ return s.replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

function makeNoteItem(id, data) {
  const el = document.createElement("div");
  el.className = "note-item";

  const nickNormalized = normalizeNick(data.nick || "");
  const isSpecial = SPECIAL_NICK.includes(nickNormalized);

if (isSpecial) {
  const info = SPECIAL_NICK_MAP[nickNormalized];
  const fakeNick = info?.label || "â“ë¹„ë°€ë‹‰ë„¤ì„";
  const nickColor = info?.color || "";

  el.innerHTML = `
    <div class="nick" style="color:${nickColor}">
      ${fakeNick}
    </div>
    <div class="text">${escapeHtml(data.text)}</div>
    <button class="delete-btn">ì‚­ì œ</button>
  `;
  el.classList.add("special-note");
}
 else {
    // ì¼ë°˜ ìœ ì €
    el.innerHTML = `
<div class="nick">${escapeHtml(getDisplayNick(data.nick))}</div>
      <div class="text">${escapeHtml(data.text)}</div>
      <button class="delete-btn">ì‚­ì œ</button>
    `;
  }

  el.querySelector(".delete-btn").addEventListener("click", () => {
    if (confirm("ì‚­ì œí• ê¹Œìš”?")) deleteMessage(id);
  });

  return el;
}

  /* íë¥´ëŠ” í…ìŠ¤íŠ¸ ìŠ¤í° - ë³€ê²½: bodyê°€ ì•„ë‹ˆë¼ #flowAreaì— ì¶”ê°€í•˜ì—¬ ìºë¦­í„° ë’¤ì— ìœ„ì¹˜í•˜ê²Œ í•¨ */
  function startSpawner(id){
    if(spawnerActive.get(id)) return;
    spawnerActive.set(id,true);

    (function spawnLoop(){
      if(!spawnerActive.get(id)) return;
      const m = messagesMap.get(id);
      if(!m){ spawnerActive.delete(id); return; }

      const el = document.createElement("div");
      el.className="flow-text";

      const fontSize = Math.floor(Math.random()*12)+14;
      const hue = Math.random()*20+20;
      const sat = Math.random()*10+20;
      const light = Math.random()*10+25;
      el.style.fontSize = fontSize+"px";
      el.style.top = (Math.random()*75+5)+"vh";

      const duration = Math.random()*4+5;
      el.style.animationDuration = duration+"s";

const nick = normalizeNick(m.nick);

const SPECIAL_NICK = [
  "ì›ì¤€ì‹ì „ë„ì‹œë½í­íƒ„ë‘ë¦¬ì¹˜í‚¨ë”ì¡°ì´",
  "ë©”ì´ë“œìŸê°•ì¤€í˜¸"
].map(normalizeNick);

if (SPECIAL_NICK_MAP[nick]) {
  const info = SPECIAL_NICK_MAP[nick];

  el.classList.add("special");
  el.style.color = info.color; // ìƒ‰ë„ ê°™ì´ ë§ì¶”ê¸° (ì„ íƒ)
  el.textContent = `${info.label} : ${m.text}`;
} else {
  el.style.color = `hsl(${hue} ${sat}% ${light}%)`;
el.textContent = `${getDisplayNick(m.nick)}: ${m.text}`;
}

      const flowArea = document.getElementById('flowArea');
      flowArea.appendChild(el);

let removed = false;

function scheduleRemove(delay = 1000) {
  if (removed) return;
  removed = true;

  setTimeout(() => {
    el.style.transition = "opacity 0.6s ease, transform 0.6s ease";
    el.style.opacity = "0";
    el.style.transform = "scale(0.8) rotate(10deg)";
setTimeout(() => {
  el.remove();

  // ğŸ”¥ ë‹¤ìŒ í…ìŠ¤íŠ¸ ë‹¤ì‹œ í˜ëŸ¬ê°€ê²Œ
  if (spawnerActive.get(id) && messagesMap.has(id)) {
    const gap = Math.random() * 1500 + 800;
    setTimeout(spawnLoop, gap);
  } else {
    spawnerActive.delete(id);
  }

}, 600);
  }, delay);
}

let grabOffsetX = 0;
let grabOffsetY = 0;

// === ë“œë˜ê·¸ & ë˜ì§€ê¸° ===
let startX = 0, startY = 0;
let lastX = 0, lastY = 0;
let velocityX = 0, velocityY = 0;
let lastTime = 0;

el.addEventListener("mousedown", (e) => {
  e.preventDefault(); // âœ… ë“œë˜ê·¸ ê°•ì œ

  const dragLayer = document.getElementById("dragLayer");
  dragLayer.style.pointerEvents = "auto"; // â­ í•µì‹¬

  el.dataset.dragging = "true";
  el.classList.add("grabbing");

  // ğŸ”¥ í˜„ì¬ í™”ë©´ ê¸°ì¤€ ì¢Œí‘œ
  const rect = el.getBoundingClientRect();

  grabOffsetX = e.clientX - rect.left;
  grabOffsetY = e.clientY - rect.top;

  // ğŸ”¥ ì¢Œí‘œ ê³ ì • (transform í¡ìˆ˜)
  el.style.left = rect.left + "px";
  el.style.top  = rect.top  + "px";

  // ğŸ”¥ ì• ë‹ˆë©”ì´ì…˜ / transform ì œê±°
  el.style.animation = "none";
  el.style.transform = "none";

  // ğŸ”¥ dragLayerë¡œ ì´ë™
  originalParent = el.parentNode;
  originalNextSibling = el.nextSibling;
  dragLayer.appendChild(el);

  // ğŸ”¥ fixed ê¸°ì¤€ + ìµœìƒë‹¨
  el.style.position = "fixed";
  el.style.zIndex = "2147483647";
  el.style.pointerEvents = "auto";

  el.style.opacity = "1";
  el.style.visibility = "visible";

  lastX = e.clientX;
  lastY = e.clientY;
  lastTime = performance.now();
});

document.addEventListener("mousemove", (e) => {
  if (el.dataset.dragging !== "true") return;

  // ğŸ”¥ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ - ì¡ì€ ì§€ì 
  el.style.left = e.clientX - grabOffsetX + "px";
  el.style.top  = e.clientY - grabOffsetY + "px";

  const now = performance.now();
  const dt = now - lastTime;

  velocityX = (e.clientX - lastX) / dt;
  velocityY = (e.clientY - lastY) / dt;

  lastX = e.clientX;
  lastY = e.clientY;
  lastTime = now;
});

document.addEventListener("mouseup", () => {
  if (el.dataset.dragging !== "true") return;

  const dragLayer = document.getElementById("dragLayer");
  dragLayer.style.pointerEvents = "none";

  el.dataset.dragging = "false";
  el.classList.remove("grabbing");

el.style.zIndex = "";
el.style.pointerEvents = "";
el.style.visibility = "";

  document.body.classList.remove("dragging-cursor");

 scheduleRemove(1000);

  let vx = velocityX * 60;
  let vy = velocityY * 60;

  const friction = 0.98;
  const bounce = 0.85;

  const rect = el.getBoundingClientRect();
  let x = rect.left;
  let y = rect.top;

function physicsLoop() {
  vx *= friction;
  vy *= friction;

  x += vx;
  y += vy;

  const maxX = window.innerWidth - rect.width;
  const maxY = window.innerHeight - rect.height;

  let hit = false;

  if (x <= 0) { x = 0; vx *= -bounce; hit = true; }
  else if (x >= maxX) { x = maxX; vx *= -bounce; hit = true; }

  if (y <= 0) { y = 0; vy *= -bounce; hit = true; }
  else if (y >= maxY) { y = maxY; vy *= -bounce; hit = true; }

  el.style.left = x + "px";
  el.style.top  = y + "px";

  if (hit) scheduleRemove(1000);

  if (Math.abs(vx) > 0.3 || Math.abs(vy) > 0.3) {
    requestAnimationFrame(physicsLoop);
  } else {
    // âœ… ë©ˆì¶˜ ë’¤ ë³µê·€
    if (originalParent) {
      if (originalNextSibling) {
        originalParent.insertBefore(el, originalNextSibling);
      } else {
        originalParent.appendChild(el);
      }
    }

    el.style.position = "";
    el.style.left = "";
    el.style.top = "";
    el.style.zIndex = "";
  }
}

// âœ… ì—¬ê¸°ì„œ ë”± í•œ ë²ˆë§Œ í˜¸ì¶œ
physicsLoop();
});

      el.addEventListener("animationend", ()=>{
      if (el.dataset.dragged === "true") return;
        el.remove();
        if(spawnerActive.get(id) && messagesMap.has(id)){
          const gap = Math.random()*1500+800;
          setTimeout(spawnLoop, gap);
        } else {
          spawnerActive.delete(id);
        }
      });
    })();
  }

  function stopSpawner(id){ spawnerActive.set(id,false); spawnerActive.delete(id); }

  /* Firestore ì‹¤ì‹œê°„ ë°˜ì˜ */
  onSnapshot(messagesQuery, (snap)=>{
    list.innerHTML="";
    const newIds = new Set();

    snap.forEach(docSnap=>{
      const id = docSnap.id; const d = docSnap.data();
      newIds.add(id);
      messagesMap.set(id,{ id, nick: d.nick || "ìµëª…", text: d.text || "", time:d.time });
    });

    for(const id of Array.from(messagesMap.keys())){
      if(!newIds.has(id)){ messagesMap.delete(id); stopSpawner(id); }
    }

    for(const [id,data] of messagesMap){ list.appendChild(makeNoteItem(id,data)); if(!spawnerActive.get(id)) startSpawner(id); }
  });
}

window.initFirebase = initFirebase;

</script>

<!-- ì˜¤ë¯¸ì¿ ì§€ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ (ì›ë³¸ ê¸°ëŠ¥ë“¤ ì „ë¶€ ìœ ì§€) -->
<script type="module">
const startScreen = document.getElementById("startScreen");
const loadingScreen = document.getElementById("loadingScreen");
const loadingBar = document.getElementById("loadingBar");
const gameScreen = document.getElementById("gameScreen");
const startBtn = document.getElementById("startBtn");
const box = document.getElementById("box");
const stick = document.getElementById("stick");
const stickText = document.getElementById("stickText");
const paperWrapper = document.getElementById("paperWrapper");
const paperText = document.getElementById("paperText");
const btn = document.getElementById("draw");
const resetBtn = document.getElementById("resetBtn");
const loadingText = document.getElementById("loadingText");
const charLeft = document.getElementById("charLeft");
const charRight = document.getElementById("charRight");
const bgm = document.getElementById("bgm");
const clickSound = document.getElementById("clickSound");
const c_clickSound = document.getElementById("c_clickSound");
const startSound = document.getElementById("startSound");
const shakeSound = document.getElementById("shakeSound");
const volumeSlider = document.getElementById("volumeSlider");
const smokeLeft  = document.getElementById("smokeLeft");
const smokeRight = document.getElementById("smokeRight");
const boomL = document.getElementById("boomL");
const boomR = document.getElementById("boomR");

// ì‹œì‘í•  ë•Œ ê¸°ë³¸ê°’ ë™ê¸°í™”
volumeSlider.value = bgm.volume;

// ìŠ¬ë¼ì´ë“œí•  ë•Œ ë³¼ë¥¨ ì¡°ì ˆ
volumeSlider.addEventListener("input", () => {
  bgm.volume = volumeSlider.value;
});

function preloadImage(src) {
  return new Promise(res => {
    const img = new Image();
    img.onload = res;
    img.src = src;
  });
}

function changeCharacterWithSmokeByResult(result){

  let targetSmoke = null;

  if (result === "ëŒ€ê¸¸") {
    targetSmoke = smokeRight;
  }

  if (result === "ëŒ€í‰") {
    targetSmoke = smokeLeft;
  }

  // ì—°ê¸° ì—†ëŠ” ê²°ê³¼ëŠ” ë°”ë¡œ êµì²´
  if (!targetSmoke) {
  if (resultCharacters[result]) {
    charLeft.src  = resultCharacters[result].left;
    charRight.src = resultCharacters[result].right;
  }
  return;
}

  // ì—°ê¸° ì¬ìƒ
  targetSmoke.classList.remove("show");
  void targetSmoke.offsetWidth;
  targetSmoke.classList.add("show");

  // ì—°ê¸° ì¤‘ê°„ì— ìºë¦­í„° êµì²´
  setTimeout(() => {
    if (resultCharacters[result]) {
      charLeft.src  = resultCharacters[result].left;
      charRight.src = resultCharacters[result].right;
    }
  }, 260);
}

const resultCharacters = {
  "ëŒ€ê¸¸": { left: "character_img/react/left_ëŒ€ê¸¸.webp", right: "character_img/react/right_ëŒ€ê¸¸.webp" },
  "ì¤‘ê¸¸": { left: "character_img/react/left_ì¤‘ê¸¸.webp", right: "character_img/react/right_ì¤‘ê¸¸.webp" },
  "ì†Œê¸¸": { left: "character_img/react/left_ì†Œê¸¸.webp", right: "character_img/react/right_ì†Œê¸¸.webp" },
  "ì†Œí‰": { left: "character_img/react/left_ì†Œí‰.webp", right: "character_img/react/right_ì†Œí‰.webp" },
  "ì¤‘í‰": { left: "character_img/react/left_ì¤‘í‰.webp", right: "character_img/react/right_ì¤‘í‰.webp" },
  "ëŒ€í‰": { left: "character_img/react/left_ëŒ€í‰.webp", right: "character_img/react/right_ëŒ€í‰.webp" }
};

function fadeVolume(audio, target, duration) {
  const steps = 20;
  const stepTime = duration / steps;
  const startVolume = audio.volume;
  const diff = target - startVolume;
  let count = 0;

  const fade = setInterval(() => {
    count++;
    audio.volume = startVolume + diff * (count / steps);
    if (count >= steps) clearInterval(fade);
  }, stepTime);
}

shakeSound.addEventListener("play", () => {
  fadeVolume(bgm, 0.1, 300);
});

/* ì‹œì‘í•˜ê¸° â†’ ë¡œë”© í™”ë©´ â†’ ê²Œì„ í™”ë©´ */
startBtn.addEventListener("click", async () => {
  await window.initFirebase();
  bgm.volume = 0.4;
  bgm.play();
  startSound.currentTime = 0;
  startSound.play();

  startScreen.style.display = "none";
  loadingScreen.style.display = "flex";

  await Promise.all([
    preloadImage("character_img/left.webp"),
    preloadImage("character_img/right.webp"),
    preloadImage("body_img/bg/game_bg.webp"),
    preloadImage("body_img/bg/box.webp")
  ]);

  let progress = 0;
  const messages = [
    { percent: 0,   text: "ì ê´˜ë¥¼ ì ì–´ë‚´ëŠ” ì¤‘..." },
    { percent: 30,  text: "í†µì„ í”ë“¤ì–´ ë³´ëŠ” ì¤‘..." },
    { percent: 60,  text: "ì‹ ë ¹ë‹˜ê»˜ ê¸°ë„í•˜ëŠ” ì¤‘..." },
    { percent: 90, text: "ì¤€ë¹„ ì™„ë£Œ!" }
  ];

  const timer = setInterval(() => {
    progress += 4;
    loadingBar.style.width = progress + "%";

    for (let i = messages.length - 1; i >= 0; i--) {
      if (progress >= messages[i].percent) {
        loadingText.textContent = messages[i].text;
        break;
      }
    }

    const loadingImg = document.getElementById("loadingImg");
    if (progress < 30) loadingImg.src = "character_img/loading/load_1.webp";
    else if (progress < 60) loadingImg.src = "character_img/loading/load_2.webp";
    else if (progress < 90) loadingImg.src = "character_img/loading/load_3.webp";
    else loadingImg.src = "character_img/loading/load_4.webp";

    if (progress >= 100) {
      clearInterval(timer);
      setTimeout(() => {
        loadingScreen.style.display = "none";
        gameScreen.style.display = "flex";
        charLeft.classList.add('show');
        charRight.classList.add('show');
      }, 200);
    }
  }, 80);
});

/* í™•ë¥  */
const resultWeights = [
  { result: "ëŒ€ê¸¸", weight: 10 },
  { result: "ì¤‘ê¸¸", weight: 15 },
  { result: "ì†Œê¸¸", weight: 25 },
  { result: "ì†Œí‰", weight: 25 },
  { result: "ì¤‘í‰", weight: 15 },
  { result: "ëŒ€í‰", weight: 10 }
];

// ê°€ì¤‘ì¹˜ ëœë¤ ì¶”ì¶œ
function pickWeightedResult() {
  const totalWeight = resultWeights.reduce((s, i) => s + i.weight, 0);
  let rand = Math.random() * totalWeight;

  for (const item of resultWeights) {
    if (rand < item.weight) return item.result;
    rand -= item.weight;
  }
}

const resultPaperImages = {
  "ëŒ€ê¸¸":"body_img/result/paper_ëŒ€ê¸¸.webp",
  "ì¤‘ê¸¸":"body_img/result/paper_ì¤‘ê¸¸.webp",
  "ì†Œê¸¸":"body_img/result/paper_ì†Œê¸¸.webp",
  "ì†Œí‰":"body_img/result/paper_ì†Œí‰.webp",
  "ì¤‘í‰":"body_img/result/paper_ì¤‘í‰.webp",
  "ëŒ€í‰":"body_img/result/paper_ëŒ€í‰.webp"
};

function spawnPaperParticles() {
  const area = document.getElementById("paperParticleArea");
  if (!area) return;

  area.innerHTML = ""; // ê¸°ì¡´ íŒŒí‹°í´ ì œê±°

  const positions = [
    { left: "-20%", top: "-20%" }, 
    { left: "-50%", top: "20%" },
    { left: "110%", top: "80%" },
    { left: "110%", top: "110%" },
  ];

  positions.forEach(pos => {

    // ìœ„ì¹˜ë§ˆë‹¤ ê°œìˆ˜ ë‹¤ë¥´ê²Œ (1~3ê°œ)
    const count = 1 + Math.floor(Math.random() * 2);

    for (let i = 0; i < count; i++) {

      const p = document.createElement("div");
      p.classList.add("paper-particle");

      /* â­ ëœë¤ í¬ê¸° (40px ~ 120px) */
      const size = 40 + Math.random() * 80;  
      p.style.width = size + "px";
      p.style.height = size + "px";

      const angle = Math.random() * Math.PI * 2;
      const distance = 40 + Math.random() * 40;

      const tx = Math.cos(angle) * distance;
      const ty = Math.sin(angle) * distance;

      p.style.setProperty("--tx", `${tx}px`);
      p.style.setProperty("--ty", `${ty}px`);

      p.style.left = pos.left;
      p.style.top = pos.top;

      area.appendChild(p);

      p.addEventListener("animationend", () => p.remove());
    }
  });
}

let isTouchChangeEnabled = true;

/* â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“ */
/* ================== í´ë¦­ ë³€ê²½ ë³´í˜¸ ì‹œìŠ¤í…œ ì¶”ê°€ ================== */

let isResultShown = false;   // ê²°ê³¼ í‘œì‹œ ì¤‘ì¸ì§€
let leftTimer = null;
let rightTimer = null;
let leftBusy = false;
let rightBusy = false;

// 5ì´ˆ ë™ì•ˆ ì„ì‹œ ì´ë¯¸ì§€ ì ìš©
function tempChangeCharacter(targetImg, newSrc, duration, setBusy) {

  // í´ë¦­ íƒ€ì´ë¨¸ ì¤‘ë³µ ë°©ì§€ â†’ ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
  if (targetImg === charLeft && leftTimer) {
    clearTimeout(leftTimer); leftTimer = null;
  }
  if (targetImg === charRight && rightTimer) {
    clearTimeout(rightTimer); rightTimer = null;
  }

  const originalSrc = targetImg.src;
  targetImg.src = newSrc;

  const timer = setTimeout(() => {

    // â­ ê²°ê³¼ê°€ ë‚˜ì˜¨ ë’¤ë¼ë©´ "ì›ë˜ ì´ë¯¸ì§€ë¡œ ë˜ëŒë¦¬ì§€ ì•ŠìŒ"
    if (!isResultShown) {
      targetImg.src = originalSrc;
    }

    setBusy(false);

    if (targetImg === charLeft) leftTimer = null;
    if (targetImg === charRight) rightTimer = null;

  }, duration);

  if (targetImg === charLeft) leftTimer = timer;
  if (targetImg === charRight) rightTimer = timer;
}

// í´ë¦­ ëˆŒë¦¼ íš¨ê³¼ (í•­ìƒ)
function pressEffect(target) {
  target.classList.add("pressed");
  setTimeout(() => target.classList.remove("pressed"), 150);
}

/* ================== í´ë¦­ ë³€ê²½ ë³´í˜¸ END ================== */
/* â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘ */

btn.addEventListener("click", () => {
  clickSound.currentTime = 0;
  clickSound.play();

  shakeSound.currentTime = 0;
  shakeSound.play();

  setTimeout(() => { shakeSound.pause(); shakeSound.currentTime = 0; }, 1000);

  /* ===== click íƒ€ì´ë¨¸ ì¦‰ì‹œ ì¤‘ì§€(í•µì‹¬ì½”ë“œ) ===== */
  if (leftTimer) { clearTimeout(leftTimer); leftTimer = null; }
  if (rightTimer) { clearTimeout(rightTimer); rightTimer = null; }
  leftBusy = false;
  rightBusy = false;
  isResultShown = false;   // ìƒˆë¡œìš´ í”ë“¤ê¸° ì‹œì‘ â†’ ê²°ê³¼ ìƒíƒœ ì´ˆê¸°í™”
  isTouchChangeEnabled = false;
  /* ============================================== */

  charLeft.src = "character_img/left_react.webp"; 
  charRight.src = "character_img/right_react.webp";

  charLeft.classList.add("fast-shake");
  charRight.classList.add("fast-shake");

  setTimeout(() => {
    charLeft.classList.remove("fast-shake");
    charRight.classList.remove("fast-shake");
  }, 900);

  resetBtn.style.display = "none";

  const boxHeight = box.offsetHeight;
  stick.style.bottom = `${boxHeight - 200}px`;
  stickText.style.opacity = 0;
  box.classList.add("shaking");

  setTimeout(() => {
    box.classList.remove("shaking");
    stick.style.bottom = `${boxHeight - 10}px`;

    setTimeout(() => {

      const result = pickWeightedResult();
      stickText.textContent = result;
      stickText.style.opacity = 1;

      playResultBgm(result);

if (result === "ëŒ€ê¸¸") {
  boomR.volume = 0.1;
  boomR.currentTime = 0;
  boomR.play();
}

if (result === "ëŒ€í‰") {
  boomL.volume = 0.1;
  boomL.currentTime = 0;
  boomL.play();
}

changeCharacterWithSmokeByResult(result);

      /* ==== ê²°ê³¼ ìƒíƒœ ì§„ì… (í´ë¦­ íƒ€ì´ë¨¸ê°€ ë”ëŠ” ì‘ë™ ëª»í•˜ê²Œ) ==== */
      if (leftTimer) { clearTimeout(leftTimer); leftTimer = null; }
      if (rightTimer) { clearTimeout(rightTimer); rightTimer = null; }
      leftBusy = false;
      rightBusy = false;
      /* ========================================================= */

      paperWrapper.style.background = `url("${resultPaperImages[result]}") no-repeat center/contain`;
      paperText.textContent = result;

      paperWrapper.classList.add("show");
      paperText.classList.add("show");

      if (result === "ëŒ€ê¸¸") spawnPaperParticles();

setTimeout(() => {
    resetBtn.style.display = "block";
    isResultShown = true;   //
}, 300);

    }, 900);
  }, 800);
});

/* reset ë²„íŠ¼ */
resetBtn.addEventListener("click", () => {
  clickSound.currentTime = 0;
  clickSound.play();

  isResultShown = false;
  isTouchChangeEnabled = true;

  if (leftTimer) { clearTimeout(leftTimer); leftTimer = null; }
  if (rightTimer) { clearTimeout(rightTimer); rightTimer = null; }
  leftBusy = rightBusy = false;

  charLeft.src = "character_img/left.webp";
  charRight.src = "character_img/right.webp";
  stick.style.bottom = "0px";
  stickText.style.opacity = 0;
  paperWrapper.classList.remove("show");
  paperText.classList.remove("show");
  resetBtn.style.display = "none";
});

/* ìºë¦­í„° í´ë¦­ */
charLeft.addEventListener("click", () => {
  pressEffect(charLeft);
  c_clickSound.currentTime = 0;
  c_clickSound.play();
  if (!isTouchChangeEnabled) return;
  if (leftBusy) return;
  leftBusy = true;
  tempChangeCharacter(charLeft, "character_img/react/left_í´ë¦­.webp", 5000, (v) => leftBusy = v);
});
charRight.addEventListener("click", () => {
  pressEffect(charRight);
  c_clickSound.currentTime = 0;
  c_clickSound.play();
  if (!isTouchChangeEnabled) return;
  if (rightBusy) return;
  rightBusy = true;
  tempChangeCharacter(charRight, "character_img/react/right_í´ë¦­.webp", 5000, (v) => rightBusy = v);
});

/* ë’¤ë¡œê°€ê¸° */
const backToStartBtn = document.getElementById("backToStartBtn");
backToStartBtn.addEventListener("click", () => {
  clickSound.currentTime = 0;
  clickSound.play();
  bgm.pause();
  bgm.currentTime = 0;

  isResultShown = false;
  if (leftTimer) { clearTimeout(leftTimer); leftTimer = null; }
  if (rightTimer) { clearTimeout(rightTimer); rightTimer = null; }
  leftBusy = rightBusy = false;

  resetBtn.click();
  gameScreen.style.display = "none";
  startScreen.style.display = "flex";
  charLeft.classList.remove("show");
  charRight.classList.remove("show");

  panel.style.right = "-400px";
});

/* ìŒì†Œê±° */
const muteBtn = document.getElementById("muteBtn");
muteBtn.addEventListener("click", () => {
  bgm.muted = !bgm.muted;
  muteBtn.textContent = bgm.muted ? "ğŸ”‡" : "ğŸ”Š";
});

/* BGM */
function playResultBgm(result) {
  const bgmGreat = document.getElementById("bgm_ëŒ€ê¸¸");
  const bgmMid   = document.getElementById("bgm_ì¤‘ê¸¸");
  const bgmSmall = document.getElementById("bgm_ì†Œê¸¸");
  const bgmBad   = document.getElementById("bgm_ì†Œí‰");
  const bgmMidBad = document.getElementById("bgm_ì¤‘í‰");
  const bgmVeryBad = document.getElementById("bgm_ëŒ€í‰");

  const bgmList = [bgmGreat, bgmMid, bgmSmall, bgmBad, bgmMidBad, bgmVeryBad];
  bgmList.forEach(b => { if (b) { b.pause(); b.currentTime = 0; } });

  let target = null;
  switch (result) {
    case "ëŒ€ê¸¸": target = bgmGreat; break;
    case "ì¤‘ê¸¸": target = bgmMid; break;
    case "ì†Œê¸¸": target = bgmSmall; break;
    case "ì†Œí‰": target = bgmBad; break;
    case "ì¤‘í‰": target = bgmMidBad; break;
    case "ëŒ€í‰": target = bgmVeryBad; break;
  }

  if (!target) return;

  target.volume = 0.4;
  target.play();

  target.onended = () => fadeVolume(bgm, volumeSlider.value, 400);
}
</script>
<div id="dragLayer"></div>
</body>
</html>















